{"version":3,"file":"index.esm.js","sources":["../src/DragndropPlugin.ts","../src/index.ts"],"sourcesContent":["import { __awaiter, __generator } from \"tslib\";\nimport { distanceSquareRoot } from '@antv/util';\nvar DragndropPlugin = /** @class */ (function () {\n    function DragndropPlugin(dragndropPluginOptions) {\n        this.dragndropPluginOptions = dragndropPluginOptions;\n    }\n    DragndropPlugin.prototype.apply = function (context) {\n        var _this = this;\n        var renderingService = context.renderingService, renderingContext = context.renderingContext;\n        var document = renderingContext.root.ownerDocument;\n        // TODO: should we add an option like `draggable` to Canvas\n        var canvas = document.defaultView;\n        var handlePointerdown = function (event) {\n            var target = event.target;\n            var isDocument = target === document;\n            var draggableEventTarget = isDocument && _this.dragndropPluginOptions.isDocumentDraggable\n                ? document\n                : target.closest && target.closest('[draggable=true]');\n            // `draggable` may be set on ancestor nodes:\n            // @see https://github.com/antvis/G/issues/1088\n            if (draggableEventTarget) {\n                // delay triggering dragstart event\n                var dragstartTriggered_1 = false;\n                var dragstartTimeStamp_1 = event.timeStamp;\n                var dragstartClientCoordinates_1 = [\n                    event.clientX,\n                    event.clientY,\n                ];\n                var currentDroppable_1 = null;\n                var lastDragClientCoordinates_1 = [event.clientX, event.clientY];\n                // @ts-ignore\n                // eslint-disable-next-line no-inner-declarations\n                var handlePointermove_1 = function (event) { return __awaiter(_this, void 0, void 0, function () {\n                    var timeElapsed, distanceMoved, point, elementsBelow, elementBelow, droppableBelow;\n                    return __generator(this, function (_a) {\n                        switch (_a.label) {\n                            case 0:\n                                if (!dragstartTriggered_1) {\n                                    timeElapsed = event.timeStamp - dragstartTimeStamp_1;\n                                    distanceMoved = distanceSquareRoot([event.clientX, event.clientY], dragstartClientCoordinates_1);\n                                    // check thresholds\n                                    if (timeElapsed <=\n                                        this.dragndropPluginOptions.dragstartTimeThreshold ||\n                                        distanceMoved <=\n                                            this.dragndropPluginOptions.dragstartDistanceThreshold) {\n                                        return [2 /*return*/];\n                                    }\n                                    // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragstart_event\n                                    event.type = 'dragstart';\n                                    draggableEventTarget.dispatchEvent(event);\n                                    dragstartTriggered_1 = true;\n                                }\n                                // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/drag_event\n                                event.type = 'drag';\n                                // @ts-ignore\n                                event.dx = event.clientX - lastDragClientCoordinates_1[0];\n                                // @ts-ignore\n                                event.dy = event.clientY - lastDragClientCoordinates_1[1];\n                                draggableEventTarget.dispatchEvent(event);\n                                lastDragClientCoordinates_1 = [event.clientX, event.clientY];\n                                if (!!isDocument) return [3 /*break*/, 2];\n                                point = this.dragndropPluginOptions.overlap === 'pointer'\n                                    ? [event.canvasX, event.canvasY]\n                                    : target.getBounds().center;\n                                return [4 /*yield*/, document.elementsFromPoint(point[0], point[1])];\n                            case 1:\n                                elementsBelow = _a.sent();\n                                elementBelow = elementsBelow[elementsBelow.indexOf(target) + 1];\n                                droppableBelow = (elementBelow === null || elementBelow === void 0 ? void 0 : elementBelow.closest('[droppable=true]')) ||\n                                    (this.dragndropPluginOptions.isDocumentDroppable\n                                        ? document\n                                        : null);\n                                if (currentDroppable_1 !== droppableBelow) {\n                                    if (currentDroppable_1) {\n                                        // null when we were not over a droppable before this event\n                                        // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragleave_event\n                                        event.type = 'dragleave';\n                                        event.target = currentDroppable_1;\n                                        currentDroppable_1.dispatchEvent(event);\n                                    }\n                                    if (droppableBelow) {\n                                        // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragleave_event\n                                        event.type = 'dragenter';\n                                        event.target = droppableBelow;\n                                        droppableBelow.dispatchEvent(event);\n                                    }\n                                    currentDroppable_1 = droppableBelow;\n                                    if (currentDroppable_1) {\n                                        // null if we're not coming over a droppable now\n                                        // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragover_event\n                                        event.type = 'dragover';\n                                        event.target = currentDroppable_1;\n                                        currentDroppable_1.dispatchEvent(event);\n                                    }\n                                }\n                                _a.label = 2;\n                            case 2: return [2 /*return*/];\n                        }\n                    });\n                }); };\n                canvas.addEventListener('pointermove', handlePointermove_1);\n                var stopDragging = function (originalPointerUpEvent) {\n                    if (dragstartTriggered_1) {\n                        // prevent click event being triggerd\n                        // @see https://github.com/antvis/G/issues/1091\n                        originalPointerUpEvent.detail = {\n                            preventClick: true,\n                        };\n                        // clone event first\n                        var event_1 = originalPointerUpEvent.clone();\n                        // drop should fire before dragend\n                        // @see https://javascript.tutorialink.com/is-there-a-defined-ordering-between-dragend-and-drop-events/\n                        if (currentDroppable_1) {\n                            // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/drop_event\n                            event_1.type = 'drop';\n                            event_1.target = currentDroppable_1;\n                            currentDroppable_1.dispatchEvent(event_1);\n                        }\n                        // @see https://developer.mozilla.org/zh-CN/docs/Web/API/Document/dragend_event\n                        event_1.type = 'dragend';\n                        draggableEventTarget.dispatchEvent(event_1);\n                        dragstartTriggered_1 = false;\n                    }\n                    canvas.removeEventListener('pointermove', handlePointermove_1);\n                };\n                target.addEventListener('pointerup', stopDragging, { once: true });\n                target.addEventListener('pointerupoutside', stopDragging, {\n                    once: true,\n                });\n            }\n        };\n        renderingService.hooks.init.tap(DragndropPlugin.tag, function () {\n            canvas.addEventListener('pointerdown', handlePointerdown);\n        });\n        renderingService.hooks.destroy.tap(DragndropPlugin.tag, function () {\n            canvas.removeEventListener('pointerdown', handlePointerdown);\n        });\n    };\n    DragndropPlugin.tag = 'Dragndrop';\n    return DragndropPlugin;\n}());\nexport { DragndropPlugin };\n//# sourceMappingURL=DragndropPlugin.js.map","import { __assign, __extends } from \"tslib\";\nimport { AbstractRendererPlugin } from '@antv/g-lite';\nimport { DragndropPlugin } from './DragndropPlugin';\nvar Plugin = /** @class */ (function (_super) {\n    __extends(Plugin, _super);\n    function Plugin(options) {\n        if (options === void 0) { options = {}; }\n        var _this = _super.call(this) || this;\n        _this.options = options;\n        _this.name = 'dragndrop';\n        return _this;\n    }\n    Plugin.prototype.init = function () {\n        this.addRenderingPlugin(new DragndropPlugin(__assign({ overlap: 'pointer', isDocumentDraggable: false, isDocumentDroppable: false, dragstartDistanceThreshold: 0, dragstartTimeThreshold: 0 }, this.options)));\n    };\n    Plugin.prototype.destroy = function () {\n        this.removeAllRenderingPlugins();\n    };\n    Plugin.prototype.setOptions = function (options) {\n        Object.assign(this.plugins[0].dragndropPluginOptions, options);\n    };\n    return Plugin;\n}(AbstractRendererPlugin));\nexport { Plugin };\n//# sourceMappingURL=index.js.map"],"names":[],"mappings":"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"}